services:
  apache_creativehub:
    # nom du service
    build: apache # dossier contenant le Dockerfile
    container_name: ${APACHE_CONTAINER:-apache_vierge} # nom du container
    restart: unless-stopped # redémarrage automatique (meilleur que always)
    ports:
      # ports exposés
      - "${APACHE_PORT:-80}:80"
    volumes:
      # volumes montés
      - ./www:/var/www/html
      - ./apache/custom-php.ini:/usr/local/etc/php/conf.d/custom-php.ini
    environment:
      # variables d'environnement
      - PHP_ERROR_REPORTING=${PHP_ERROR_REPORTING:-E_ALL} # afficher toutes les erreurs
      - PHP_DISPLAY_ERRORS=${PHP_DISPLAY_ERRORS:-On} # afficher les erreurs
    networks:
      - app_network # réseau isolé pour la communication entre services
    depends_on:
      mariadb_creativehub:
        condition: service_healthy # attendre que MariaDB soit prêt
    healthcheck:
      # vérification de santé du container (utilise wget qui est installé)
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Limites de ressources (pour Docker Compose standard)
    mem_limit: 512m
    mem_reservation: 256m
    cpus: 2.0

  mariadb_creativehub:
    # nom du service
    image: mariadb:11.3 # version fixe pour la reproductibilité (au lieu de latest)
    container_name: ${MARIADB_CONTAINER:-mariadb_vierge} # nom du container
    restart: unless-stopped # redémarrage automatique (meilleur que always)
    ports:
      # ports exposés
      - "${MARIADB_PORT:-3306}:3306"
    environment:
      # variables d'environnement (utiliser un fichier .env pour la sécurité)
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-superAdmin} # mot de passe root
      - MYSQL_DATABASE=${MYSQL_DATABASE:-bdd_name} # nom de la base de données
      - MYSQL_USER=${MYSQL_USER:-admin} # nom de l'utilisateur
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-admin} # mot de passe de l'utilisateur
      - MYSQL_ROOT_HOST=${MYSQL_ROOT_HOST:-%} # autoriser les connexions root depuis n'importe quel host
    volumes:
      # volumes montés
      - mysql:/var/lib/mysql
      - ./db:/docker-entrypoint-initdb.d # exécution automatique des scripts SQL au démarrage
    networks:
      - app_network # réseau isolé pour la communication entre services
    healthcheck:
      # vérification de santé du container
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    # Limites de ressources (pour Docker Compose standard)
    mem_limit: 1g
    mem_reservation: 512m
    cpus: 2.0

networks:
  app_network:
    # réseau personnalisé pour isoler les services
    driver: bridge

volumes:
  mysql: # volume nommé pour persister les données MariaDB
